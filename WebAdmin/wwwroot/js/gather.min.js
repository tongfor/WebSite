function delArticle(n,t){var i=$(t),r={id:n};$.ajax({url:"/Article/DeleteAjax",type:"POST",data:r,timeout:3e6,beforeSend:function(){i.attr("disabled","true")},success:function(n,t){n&&n.msg&&n.msg!=undefined&&("success"===t&&0===n.status&&(i.parent().remove(),gatherCache.set(siteGather.cacheName,$(".gather-result").html(),120)),alert(n.msg));i.removeAttr("disabled")},error:function(n,t,r){i.removeAttr("disabled");document.write(n.responseText);console.log(n);console.log(t);console.log(r)},complete:function(n,t){"timeout"===t&&(ajaxTimeoutTest.abort(),console.log("超时"))}})}function heartbeatConn(){$.ajax({url:"/Spider/GetGatherAllResult",type:"POST",timeout:3e6,success:function(n,t){if(n&&"success"===t&&0===n.status&&n.data){siteGather.gatherAllCache=n.data;$(".gather-result").html("");for(var i in n.data)siteGather.showGatherResult("gather-result",n.data[i])}},error:function(n,t,i){document.write(n.responseText);console.log(n);console.log(t);console.log(i)},complete:function(n,t){"timeout"===t&&(ajaxTimeoutTest.abort(),console.log("超时"))}})}var siteGather=function(){function f(n,t){var i=new Date(n),r,u;return!i||!t||0===t.length||isNaN(t)?!1:(r=new Date,u=r.getTime()-i.getTime(),u<=t*864e5)}var n=[{id:1,siteName:"市经委",siteKey:"cdgy",startPageNo:1,endPageNo:5},{id:5,siteName:"省经信厅",siteKey:"jxt",startPageNo:1,endPageNo:5},{id:10,siteName:"市科技局",siteKey:"cdst",startPageNo:1,endPageNo:5},{id:15,siteName:"省科技厅",siteKey:"kjt",startPageNo:1,endPageNo:5},{id:16,siteName:"省人才工作网",siteKey:"srcgzw",startPageNo:1,endPageNo:5},{id:17,siteName:"蓉城先锋",siteKey:"rcxf",startPageNo:1,endPageNo:5},{id:20,siteName:"高新区",siteKey:"cdht",startPageNo:1,endPageNo:5},{id:25,siteName:"天府新区",siteKey:"cdtf",startPageNo:1,endPageNo:5},{id:30,siteName:"金牛区",siteKey:"jnq",startPageNo:1,endPageNo:5},{id:35,siteName:"锦江区",siteKey:"jjq",startPageNo:1,endPageNo:5},{id:40,siteName:"武侯区经科局",siteKey:"whqjkj",startPageNo:1,endPageNo:5},{id:45,siteName:"青羊区科经局",siteKey:"qyqkjj",startPageNo:1,endPageNo:5},{id:50,siteName:"成华区经科局",siteKey:"chqjkj",startPageNo:1,endPageNo:5},{id:55,siteName:"龙泉驿区",siteKey:"lqyq",startPageNo:1,endPageNo:5},{id:65,siteName:"青白江区科经局",siteKey:"qbjqkjj",startPageNo:1,endPageNo:5},{id:70,siteName:"新都区",siteKey:"xdq",startPageNo:1,endPageNo:5},{id:75,siteName:"温江区",siteKey:"wjq",startPageNo:1,endPageNo:5},{id:80,siteName:"双流区",siteKey:"slq",startPageNo:1,endPageNo:5},{id:85,siteName:"郫都区",siteKey:"pdq",startPageNo:1,endPageNo:5},{id:90,siteName:"简阳市",siteKey:"jys",startPageNo:1,endPageNo:5},{id:95,siteName:"都江堰市",siteKey:"djys",startPageNo:1,endPageNo:5},{id:100,siteName:"彭州市",siteKey:"pzs",startPageNo:1,endPageNo:5},{id:105,siteName:"邛崃市",siteKey:"qls",startPageNo:1,endPageNo:5},{id:110,siteName:"崇州市经信局",siteKey:"czsjxj",startPageNo:1,endPageNo:5},{id:115,siteName:"金堂县",siteKey:"jtx",startPageNo:1,endPageNo:5},{id:120,siteName:"新津县",siteKey:"xjx",startPageNo:1,endPageNo:5},{id:125,siteName:"大邑县",siteKey:"dyx",startPageNo:1,endPageNo:5},{id:130,siteName:"蒲江县经科信局",siteKey:"pjxjkxj",startPageNo:1,endPageNo:5}],t=$("#gather-list"),i="gatherCache",r=function(){var i,r;t.empty();i="<ul>\n";for(r in n)i+="    <li>\n",i+='<input value="采集'+n[r].siteName,i+='信息" id="g_'+n[r].siteKey+'_classId_2" data-classId="2"',i+='data-siteKey="'+n[r].siteKey,i+='" data-startPageNo="'+n[r].startPageNo,i+='" data-endPageNo="'+n[r].endPageNo,i+='" type = "button" class="gatherbtn" />\n',i+="<br />\n",i+='<span id="submitloading_'+n[r].siteKey,i+='_classId_2" style="display:none;text-align:center;">采集开始',i+='<br /><img src="/images/loading.gif" /><\/span >\n';i+="<\/ul>\n";t.append(i)},u=function(n,t){var e,r,u;if(n){if(e=$("."+n),r="",t)if(t.gatherMessage&&t.gatherMessage!=undefined&&t.gatherMessage.length>0)r+="采集"+t.siteName+'提示：<span style="color:red">'+t.gatherMessage+"<\/span>",r+='&nbsp;<a href="'+t.siteUrl+'" target="_blank">查看要采集的网站<\/a><\/p >\n';else if(t.gatheredArticleList){r+="<p>在"+t.gatherTime;r+="从"+t.siteName+"采集了"+t.gatheredArticleList.length+"条信息:<\/p>\n";for(u in t.gatheredArticleList)r+='<p><a href="'+t.resultShowDomainName,r+="/Article/Details-"+t.gatheredArticleList[u].id,r+='.html" title="'+t.gatheredArticleList[u].title,r+='" target="_blank">'+t.gatheredArticleList[u].title,r+="<\/a>",r+=f(t.gatheredArticleList[u].addTime,3)?'[<span class="text-error">'+t.gatheredArticleList[u].addTime+"<\/span>]":"[<span>"+t.gatheredArticleList[u].addTime+"<\/span>]",r+='&nbsp; <a href="'+t.gatheredArticleList[u].gatherurl,r+='" title="原文地址" target="_blank">原文地址<\/a>',r+='&nbsp;<a class="thickbox" title="编辑文章内容" href="/Article/Edit/',r+=t.gatheredArticleList[u].id,r+='?TB_iframe=true&amp;height=600&amp;width=950">编辑<\/a>',r+='&nbsp;<a title="删除此篇文章" ',r+='href="#" onclick="javascript:if(confirm(\'确实要删除该内容吗 ? \'))delArticle(',r+=t.gatheredArticleList[u].id+', this)">删除<\/a>',r+="<\/p>\n"}(0===e.html().length||"&nbsp;"===e.html())&&(r="<p>采集结果如下：<\/p>\n"+r);e.append(r);tb_init("a.thickbox","tr.thickbox","td.thickbox");gatherCache.set(i,e.html(),120);e.scrollTop(e.prop("scrollHeight"))}};return{menuData:n,gatherMenuInit:r,showGatherResult:u,cacheName:i,gatherAllCache:{}}}(),gatherDb,gatherCache;$(function(){var t,n;siteGather.gatherMenuInit();t=$(".gather-result");t.html("");n=gatherCache.get(siteGather.cacheName);n&&n!=undefined&&t.append(n);$(".gatherbtn").click(function(n){var t=$(n.target),r=t.attr("data-classId"),u=t.attr("data-siteKey"),i="submitloading_"+u+"_classId_"+r,f={siteKey:u,pageStartNo:t.attr("data-startPageNo"),pageEndNo:t.attr("data-endPageNo"),classId:r};return $.ajax({url:"/Spider/GatherWebsite",type:"POST",data:f,timeout:3e6,beforeSend:function(){t.attr("disabled","true");$("#"+i).show()},success:function(n,r){n&&"success"===r&&0===n.status?siteGather.showGatherResult("gather-result",n.data):n&&"error"===r&&1===n.status&&n.msg&&alert(n.msg);$("#"+i).hide();t.removeAttr("disabled")},error:function(n,r,u){$("#"+i).hide();t.removeAttr("disabled");document.write(n.responseText);console.log(n);console.log(r);console.log(u)},complete:function(n,t){"timeout"===t&&(ajaxTimeoutTest.abort(),console.log("超时"))}}),!1});$("#btnGatherAll").click(function(n){var t=$(n.target),r=t.attr("data-classId"),i="submitloading_all_classId_"+r,f={pageStartNo:1,pageEndNo:3,classId:r},u;return $.ajax({url:"/Spider/GatherAllWebsites",type:"POST",data:f,timeout:3e6,beforeSend:function(){t.attr("disabled","true");$("#"+i).show();u=setInterval(function(){heartbeatConn()},3e3)},success:function(n,r){if(clearInterval(u),n&&"success"===r&&0===n.status&&n.data){$(".gather-result").html("");for(var f in n.data)siteGather.showGatherResult("gather-result",n.data[f])}else n&&"error"===r&&1===n.status&&n.msg?alert(n.msg):n.data||alert("未获得采集结果！");$("#"+i).hide();t.removeAttr("disabled")},error:function(n,r,u){$("#"+i).hide();t.removeAttr("disabled");document.write(n.responseText);console.log(n);console.log(r);console.log(u)},complete:function(n,t){"timeout"===t&&(ajaxTimeoutTest.abort(),console.log("超时"))}}),!1})});gatherDb=function(){var n=window.localStorage,t=document.documentElement;return n||(t.style.behavior="url(#default#userData)"),{set:function(i,r,u){return n?n.setItem(i,r,u):(t.setAttribute(i,value),t.save(u||"default"))},get:function(i,r){return n?n.getItem(i,r):(t.load(r||"default"),t.getAttribute(i)||"")},rm:function(i,r){return n?n.removeItem(i,r):(r=r||"default",t.load(r),t.removeAttribute(i),t.save(r))},clear:function(){if(n)return n.clear();t.expires=-1}}}();gatherCache=function(){return{get:function(n){var i=gatherDb.get(n),t=gatherDb.get(n+"__time"),r=gatherDb.get(n+"_expiredMinutes")||60,u=(new Date).getTime(),f=u-6e4*r;if(i&&t){if(f<t)return gatherDb.get(n);gatherDb.rm(n);gatherDb.rm(n+"__time")}else return gatherDb.get(n)},set:function(n,t,i){gatherDb.set(n,t);gatherDb.set(n+"__time",(new Date).getTime());gatherDb.set(n+"_expiredMinutes",i)}}}();